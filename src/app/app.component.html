<div class="container m-2">
  <div class="card p-2">
    <div class="row">
      <div class="col">
        <h4>Nöbet Tarihlerini Seç</h4>
        <p-calendar
          [(ngModel)]="rawDates"
          (ngModelChange)="onDatesSelected($event)"
          selectionMode="multiple"
          dateFormat="dd.mm.yy"
          [showIcon]="true"
          placeholder="Tarihleri seç"
        ></p-calendar>
      </div>

      <div class="col" *ngIf="dates.length > 0">
        <h4>Kişi Ekle</h4>
        <button class="btn btn-primary" (click)="openModal()">Kişi Ekle</button>
      </div>
    </div>

    <div class="d-flex justify-content-end w-100 mt-2">
      <button class="btn btn-danger" (click)="reset()">
        <i class="pi pi-refresh me-2"></i> Reset
      </button>
    </div>
  </div>
  <div class="row mt-1">
    <div class="col">
      <div class="card p-2" *ngIf="persons.length > 0">
        <h2 class="mt-2 text-center">Kişiler</h2>

        @for (person of persons; track $index) {
        <div class="d-flex justify-content-between align-items-center mb-2">
          <!-- Kişi Adı -->
          <div class="fs-5">
            {{ person.name }}
            <span class="text-muted ms-2"
              >({{ getDutyCount(person.name) }})</span
            >
          </div>

          <!-- Butonlar -->
          <div>
            <button
              class="btn btn-outline-warning me-2"
              (click)="openModal($index)"
              title="Güncelle"
            >
              <i class="pi pi-pencil me-1"></i> Güncelle
            </button>

            <button
              class="btn btn-outline-danger"
              (click)="removePerson(person)"
              title="Sil"
            >
              <i class="pi pi-trash me-1"></i> Sil
            </button>
          </div>
        </div>
        }
      </div>
    </div>
    <div class="col"></div>
  </div>
  <div class="d-flex justify-content-end my-3" *ngIf="assignedDates.length > 0">
    <button class="btn btn-success" (click)="exportExcel()">
      <i class="pi pi-file-excel me-2"></i> Excel Olarak İndir
    </button>
  </div>
  <p *ngIf="assignedDates.length > 0" class="mt-3 fw-bold">
    Seçilen Tarihler ve Atananlar:
  </p>

  <table
    class="table table-striped table-hover"
    *ngIf="assignedDates.length > 0"
  >
    <thead>
      <tr>
        <th>Tarih</th>
        <th>Atanan</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of assignedDates">
        <td [ngClass]="{ 'bg-danger': item.person === 'Kimse atanmadı' }">
          {{ item.date | date : "dd.MM.yyyy" }}
        </td>
        <td [ngClass]="{ 'bg-danger': item.person === 'Kimse atanmadı' }">
          {{ item.person }}
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- MODAL -->
<div
  class="modal fade show d-block"
  tabindex="-1"
  role="dialog"
  *ngIf="showModal"
  style="background: rgba(0, 0, 0, 0.5)"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content p-3">
      <h5 class="modal-title">
        {{ isEditing ? "Kişiyi Güncelle" : "Kişi Ekle" }}
      </h5>
      <div class="form-group mb-2">
        <label>İsim</label>
        <input type="text" class="form-control" [(ngModel)]="personName" />
      </div>

      <div class="form-group mb-2">
        <label class="d-block mb-1">Seçilebilir Nöbet Tarihleri</label>
        <p-multiSelect
          [options]="dates"
          [(ngModel)]="selectedPersonDates"
          optionLabel="label"
          display="chip"
          placeholder="Tarihleri Seç"
          [filter]="true"
        ></p-multiSelect>
      </div>

      <div class="d-flex justify-content-end">
        <button class="btn btn-secondary me-2" (click)="closeModal()">
          İptal
        </button>
        <button class="btn btn-success" (click)="savePerson()">Kaydet</button>
      </div>
    </div>
  </div>
</div>
